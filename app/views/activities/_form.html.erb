<% if activity.errors.any? %>
  <div style="color: red">
    <h2><%= pluralize(activity.errors.count, "error") %> prohibited this activity from being saved:</h2>

    <ul>
      <% activity.errors.each do |error| %>
        <li><%= error.full_message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<%= form_with(model: activity, data: { controller: 'nested-form', nested_form_wrapper_selector_value: '.nested-form-wrapper', form_model: "activities" }, class: "form form__flex section-bg") do |form| %>
  <div class="form__field">
    <%= form.label "Proyecto", class: "form__label" %>
    <%= form.select :project_id, options_for_select(@projects.collect { |pr| [pr.name, pr.id] }, selected: activity.project_id), { prompt: "-- Seleccione un proyecto --" }, class: "form__input form-select" %>
  </div>

  <div class="form__field">
    <%= form.label "Colaborador", class: "form__label" %>
    <%= form.select :user_id, options_for_select(@collaborators.collect { |w| [w.fullname, w.id] }, selected: activity.user_id), { prompt: "-- Seleccione un colaborador --" }, class: "form__input form-select" %>
  </div>

  <div class="form__field">
    <%= form.label "Fecha", class: "form__label" %>
    <%= form.date_field :date, class: "form__input" %>
  </div>

  <div class="form__field">
     <div class="d-flex justify-content-between align-items-center mt-2">
      <%= form.label "Actividades realizadas", class: "form__label" %>
      <button type="button" data-bs-toggle="modal" data-bs-target="#phasesModal" id="addPhase" class="button-outline-primary">Seleccionar actividad</button>
    </div>

    <div class="form__table">
      <div class="form__table-head">
        <label class="form__label">Fase</label>
        <label class="form__label">Horas realizadas</label>
      </div>
      
      <%# Start Phases_Activities Nested Form %>
      <template data-nested-form-target="template">
        <%= form.fields_for :phases_activities, PhasesActivity.new, child_index: 'NEW_RECORD' do |phase_activity| %>
          <%= render "activities/phase_activity_form", f: phase_activity, phases: @phases %>
        <% end %>
      </template>
      
      <%= form.fields_for :phases_activities do |phase_activity| %>
        <%= render "activities/phase_activity_form", f: phase_activity, phases: @phases %>
      <% end %>
      
      <!-- Inserted elements will be injected before that target. -->
      <div data-nested-form-target="target"></div>
      <%# End Phases_Activities Nested Form %>
    </div>
  </div>

  <div class="form__field">
    <%= form.label "Total de horas realizadas", class: "form__label" %>
    <input type="number" id="totalHours" placeholder="Suma de horas por fase" class="form__input" readonly>
  </div>

  <div class="form__actions mt-3">
    <%= form.submit activity.new_record? ? "Guardar" : "Actualizar", class: "button-primary" %>
    <%= link_to "Regresar", activities_path, class: "button-secondary" %>
  </div>

  <%# MODAL %>
  <%= render 'activities/phase_hours_modal', phases: @phases %>
<% end %>

<% if !activity.new_record? %>
  <div class="d-flex justify-content-end">
    <%= button_to 'Eliminar', @activity, method: :delete, form:{ data: { turbo_confirm: 'Esta acción es irreversible y será registrada en el historial de cambios. ¿Está seguro(a) de que desea eliminar esta actividad?' }} , class: "btn btn-outline-danger"%>
  </div>
<% end %>