<%= render 'shared/error_message', object: activity %>

<%= form_with(model: activity, data: { controller: 'nested-form', nested_form_wrapper_selector_value: '.nested-form-wrapper', form_model: "activities" }, class: "form form__flex section-bg") do |form| %>
  <div class="form__field" data-controller="dropdown-search update-fields">
    <%= form.label "Proyecto", class: "form__label" %>

    <%= form.hidden_field :project_id, data: {id: "hidden-input"}%>
    <input type="text" name="projects" class="form__input form-select search-bar" autocomplete="off" data-action="click->dropdown-search#openDropdown keyup->dropdown-search#searchInput" data-value="" placeholder="- Selecciona una opción -">
    <select class="form-select multiple-select" data-dropdown-type="form" multiple>
        <% @projects.each do |p| %>
            <option value="<%= p.id %>"><%= p.name %></option>
        <% end %>
    </select>
  </div>

  <div class="form__field" data-controller="dropdown-search update-fields">
    <%= form.label "Colaborador", class: "form__label" %>
    <%= form.hidden_field :user_id, data: {id: "hidden-input"}%>
    
    <input type="text" name="users" class="form__input form-select search-bar" autocomplete="off" data-action="click->dropdown-search#openDropdown keyup->dropdown-search#searchInput" data-value="" placeholder="- Selecciona una opción -">
    <select class="form-select multiple-select" data-dropdown-type="form" multiple>
        <% @active_collaborators.each do |c| %>
            <option value="<%= c.id %>"><%= c.fullname %></option>
        <% end %>
    </select>

    <input type="text" id="hidden-name" value="<%= activity.user.fullname%>" disabled="true" hidden>
  </div>

  <div class="form__field">
    <%= form.label "Fecha", class: "form__label" %>
    <%= form.date_field :date, class: "form__input" %>
  </div>

  <div class="form__field">
    <div class="form__flex form__flex--row gap-1 justify-content-between mb-2">
      <%= form.label "Actividades realizadas", class: "form__label" %>
      <button type="button" data-bs-toggle="modal" data-bs-target="#phasesModal" id="addPhase" class="button-outline-primary button-outline-primary--sm">Agregar actividad</button>
    </div>

    <div class="form__table">
      <div class="form__table-head">
        <label class="form__label">Actividad</label>
        <label class="form__label">Horas</label>
      </div>

      <p id="emptyMessage" class="text-center text-black-50 fst-italic my-2 fs-xs"><i class="bi bi-info-circle me-2"></i>Agrega al menos una actividad</p>
      
      <div class="form__table-body">
        <%# Start Phases_Activities Nested Form %>
        <template data-nested-form-target="template">
          <%= form.fields_for :phases_activities, PhasesActivity.new, child_index: 'NEW_RECORD' do |phase_activity| %>
            <%= render "activities/phase_activity_form", f: phase_activity, phases: @phases %>
          <% end %>
        </template>
        
        <%= form.fields_for :phases_activities do |phase_activity| %>
          <%= render "activities/phase_activity_form", f: phase_activity, phases: @phases %>
        <% end %>
        
        <!-- Inserted elements will be injected before that target. -->
        <div data-nested-form-target="target"></div>
        <%# End Phases_Activities Nested Form %>
      </div>
    </div>
  </div>

  <div class="form__field">
    <%= form.label "Total de horas realizadas", class: "form__label" %>
    <input type="number" id="totalHours" placeholder="Suma de horas por actividad" class="form__input" readonly>
  </div>

  <div class="form__flex form__flex--row justify-content-between">
    <div class="form__actions mt-3">
      <%= form.submit activity.new_record? ? "Guardar" : "Actualizar", class: "button-primary" %>
      <%= link_to "Regresar", activities_path, class: "button-secondary" %>
    </div>

    <%# RENDER CHANGE LOG %>
    <%= render 'shared/change_log', object: @activity_change_log %>
  </div>

  <%# MODAL %>
  <%= render 'activities/phase_hours_modal', phases: @phases %>
<% end %>